<!doctype html>
<html>
<head>
  <title>Edit Job</title>
  <meta name="csrf-token" content="{{ csrf_token | default('') }}">
  <link rel="stylesheet" href="/static/styles.css">
  <script src="/static/app.js" defer></script>
</head>
<body>
  <header>
    <div class="container nav">
      <a href="/">Home</a>
      <a href="/gui/admin/sites">Sites</a>
      <a href="/gui/jobs">Jobs</a>
      <a href="/gui/jobs/start">Start Job</a>
      <a href="/gui/logout" style="margin-left:auto">Logout</a>
    </div>
  </header>
  <main class="container">
    <div class="card">
      <h1>Edit Job {{ job.id }}</h1>
      <form method="post">
        <label>Algorithm:<br>
          <input value="{{ job.algorithm }}" disabled>
        </label><br>
        <label>Name:<br><input name="name" value="{{ job.name }}"></label><br>
        <label>Description:<br><input name="description" value="{{ job.description }}"></label><br>
        <label>Participants (select approved sites):<br>
          <select name="participants" multiple size="6" required>
            {% for u in approved_users %}
              <option value="{{ u.site_id }}" {% if u.site_id in job.participants %}selected{% endif %}>{{ u.username }} ({{ u.site_id }})</option>
            {% endfor %}
          </select>
        </label><br>

        <div id="dynamic-params"></div>
        <p style="font-size:0.8em;color:#555">Parameters generated from config schema. Existing values pre-filled.</p>
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button type="submit">Save</button>
      </form>
    </div>
  </main>
  <script id="alg-schemas" type="application/json">{{ alg_schemas | tojson | safe }}</script>
  <script id="existing-params" type="application/json">{{ job.parameters | tojson | safe }}</script>
  <script>
    const ALG_SCHEMAS = JSON.parse(document.getElementById('alg-schemas').textContent);
    const algo = '{{ job.algorithm.upper() }}';
    const existing = JSON.parse(document.getElementById('existing-params').textContent);
    function render(){
      const container=document.getElementById('dynamic-params');
      container.innerHTML='';
      const schema = ALG_SCHEMAS[algo];
      if(!schema){container.textContent='No schema.';return;}
      const h=document.createElement('h3');h.textContent=algo+' Parameters';container.appendChild(h);
      const required = new Set(schema.required||[]);
      let entries = Object.entries(schema.properties||{});
      const order = Array.isArray(schema['ui:order']) ? schema['ui:order'] : [];
      if(order.length){
        const orderIndex = new Map(order.map((k,i)=>[k,i]));
        entries.sort((a,b)=>{
          const ai = orderIndex.has(a[0])?orderIndex.get(a[0]):Number.MAX_SAFE_INTEGER;
          const bi = orderIndex.has(b[0])?orderIndex.get(b[0]):Number.MAX_SAFE_INTEGER;
          return ai-bi || a[0].localeCompare(b[0]);
        });
      }
      for(const [k,def] of entries){
        const wrap=document.createElement('div');
        let input;
        const labelText=(def['ui:label']||k)+(required.has(k)?' *':'');
        if(def.type==='boolean'){
          input=document.createElement('select');input.name=k;
          const optF=document.createElement('option');optF.value='false';optF.textContent='false';
          const optT=document.createElement('option');optT.value='true';optT.textContent='true';
          input.appendChild(optF);input.appendChild(optT);
          if(String(existing[k]).toLowerCase()==='true') optT.selected=true; else optF.selected=true;
          const lab=document.createElement('label');lab.textContent=labelText+': ';wrap.appendChild(lab);wrap.appendChild(input);
        } else if(def.type==='integer' || def.type==='number'){
          input=document.createElement('input');input.type='number';input.name=k; if(existing[k]!==undefined) input.value=existing[k]; else if(def.default!==undefined) input.value=def.default;
          if(def.minimum!==undefined) input.min=def.minimum;
          wrap.innerHTML=`<label>${labelText}:<br></label>`;wrap.appendChild(input);
        } else if(def.type==='array'){
          input=document.createElement('input');input.type='text';input.name=k; if(Array.isArray(existing[k])) input.value=existing[k].join(',');
          input.placeholder=def['ui:placeholder']||'comma separated';
          wrap.innerHTML=`<label>${labelText} (array):<br></label>`;wrap.appendChild(input);
        } else {
          if(def.enum){
            input=document.createElement('select');input.name=k;def.enum.forEach(val=>{const o=document.createElement('option');o.value=val;o.textContent=val; if(existing[k]===val) o.selected=true; input.appendChild(o);});
          } else {
            input=document.createElement('input');input.type='text';input.name=k; if(existing[k]!==undefined) input.value=existing[k]; else if(def.default!==undefined) input.value=def.default; if(def['ui:placeholder']) input.placeholder=def['ui:placeholder'];
          }
          wrap.innerHTML=`<label>${labelText}:<br></label>`;wrap.appendChild(input);
        }
        if(required.has(k)) input.required=true;
        if(def.description){const d=document.createElement('div');d.style.fontSize='0.7em';d.style.color='#666';d.textContent=def.description;wrap.appendChild(d);}
        container.appendChild(wrap);
      }
      // Add universal trial count if not part of schema
      if(!('imputation_trials' in (schema.properties||{}))){
        const wrap=document.createElement('div');wrap.innerHTML='<label>imputation_trials:<br></label>';
        const i=document.createElement('input');i.type='number';i.min='1';i.name='imputation_trials';i.value=''+(existing.imputation_trials||'10');wrap.appendChild(i);container.appendChild(wrap);
      }
    }
    document.addEventListener('DOMContentLoaded', render);
  </script>
</body>
</html>
